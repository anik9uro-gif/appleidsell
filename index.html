<!DOCTYPE html>
<html lang="bn" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Panel - ‡¶∏‡ßç‡¶¨‡¶∞‡ßç‡¶£‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] } } }
    }
  </script>
</head>
<body class="bg-gray-900 text-white p-6">

  <h1 class="text-2xl font-bold mb-6">‚öôÔ∏è Admin Panel</h1>

  <!-- LOGIN -->
  <div id="loginBox" class="space-y-3">
    <input id="email" type="email" placeholder="Email" class="w-full px-3 py-2 rounded bg-white/10" required>
    <input id="password" type="password" placeholder="Password" class="w-full px-3 py-2 rounded bg-white/10" required>
    <button id="btnLogin" class="w-full px-3 py-2 rounded bg-amber-500 text-black font-semibold">Login</button>
    <p id="loginMsg" class="text-sm text-red-400"></p>
  </div>

  <!-- PANEL -->
  <div id="panel" class="hidden space-y-6 mt-6">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-semibold">üí∞ ‡¶∏‡ßç‡¶¨‡¶∞‡ßç‡¶£‡ßá‡¶∞ ‡¶¶‡¶æ‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü</h2>
        <div class="text-xs text-gray-300">Last update: <span id="updatedAt">‚Äî</span></div>
      </div>
      <div class="text-right">
        <div class="text-sm">Signed in: <span id="whoEmail" class="font-semibold"></span></div>
        <span id="whoRole" class="inline-block mt-1 px-3 py-1 rounded bg-gray-700 text-sm">‚Äî</span>
      </div>
    </div>

    <!-- TODAY -->
    <section class="p-4 bg-white/5 rounded-lg border border-white/10">
      <h3 class="font-semibold mb-3">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¶‡¶æ‡¶Æ</h3>
      <table class="min-w-full text-sm">
        <thead class="bg-amber-500 text-black">
          <tr><th class="px-3 py-2 text-left">Item</th><th class="px-3 py-2 text-left">Current</th><th class="px-3 py-2 text-left">New Price</th></tr>
        </thead>
        <tbody id="tbody-today"></tbody>
      </table>
    </section>

    <!-- OLD -->
    <section class="p-4 bg-white/5 rounded-lg border border-white/10">
      <h3 class="font-semibold mb-3">‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶ó‡¶π‡¶®‡¶æ</h3>
      <table class="min-w-full text-sm">
        <thead class="bg-amber-500 text-black">
          <tr><th class="px-3 py-2 text-left">Item</th><th class="px-3 py-2 text-left">Current</th><th class="px-3 py-2 text-left">New Price</th></tr>
        </thead>
        <tbody id="tbody-old"></tbody>
      </table>
    </section>

    <!-- NEW -->
    <section class="p-4 bg-white/5 rounded-lg border border-white/10">
      <h3 class="font-semibold mb-3">‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡¶π‡¶®‡¶æ</h3>
      <table class="min-w-full text-sm">
        <thead class="bg-amber-500 text-black">
          <tr><th class="px-3 py-2 text-left">Item</th><th class="px-3 py-2 text-left">Current</th><th class="px-3 py-2 text-left">New Price</th></tr>
        </thead>
        <tbody id="tbody-new"></tbody>
      </table>
    </section>

    <!-- SAVE -->
    <div class="flex items-center gap-2">
      <button id="btnSave" class="px-4 py-2 rounded bg-amber-500 text-black font-semibold">Save All</button>
      <span id="saveMsg" class="text-sm"></span>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, collection, doc, onSnapshot, setDoc, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { 
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, getIdTokenResult, signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó
    const firebaseConfig = {
      apiKey: "AIzaSyDt5cJ0LIrZV5NGPS02QeEj9zogPyMm3Wg",
      authDomain: "goldprice-6db2e.firebaseapp.com",
      projectId: "goldprice-6db2e",
      storageBucket: "goldprice-6db2e.firebasestorage.app",
      messagingSenderId: "666004217573",
      appId: "1:666004217573:web:832fe85d8b0d1e7b593e0c",
      measurementId: "G-H8ZZJM7E5C"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);

    // ====== DOM refs (‚úîÔ∏è ‡¶è‡¶ñ‡¶® ‡¶∏‡¶¨ ‡¶∏‡ßá‡¶´) ======
    const emailInput   = document.getElementById('email');
    const passInput    = document.getElementById('password');
    const btnLogin     = document.getElementById('btnLogin');
    const loginMsg     = document.getElementById('loginMsg');
    const loginBox     = document.getElementById('loginBox');

    const panel        = document.getElementById('panel');
    const whoEmail     = document.getElementById('whoEmail');
    const whoRole      = document.getElementById('whoRole');
    const updatedAtEl  = document.getElementById('updatedAt');

    const tbodyToday   = document.getElementById('tbody-today');
    const tbodyOld     = document.getElementById('tbody-old');
    const tbodyNew     = document.getElementById('tbody-new');

    const btnSave      = document.getElementById('btnSave');
    const saveMsg      = document.getElementById('saveMsg');

    const ADMIN_EMAIL = 'anik3uro@gmail.com'; // fallback

    const moneyFmt = new Intl.NumberFormat('bn-BD',{ style:'currency', currency:'BDT', maximumFractionDigits:0 });
    const LABELS = {
      price_24k_biscuit_bhori: '‡ß®‡ß™K ‡¶¨‡¶ø‡¶∏‡ßç‡¶ï‡ßÅ‡¶ü / ‡¶≠‡¶∞‡¶ø',
      price_24k_pasha_bhori:   '‡ß®‡ß™K ‡¶™‡¶æ‡¶∂‡¶æ / ‡¶≠‡¶∞‡¶ø',
      price_24k_biscuit_gram:  '‡ß®‡ß™K ‡¶¨‡¶ø‡¶∏‡ßç‡¶ï‡ßÅ‡¶ü / ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ',
      // old
      price_old_22k_bhori:     '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡ß®‡ß®K / ‡¶≠‡¶∞‡¶ø',
      price_old_21k_bhori:     '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡ß®‡ßßK / ‡¶≠‡¶∞‡¶ø',
      price_old_22k_gram:      '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡ß®‡ß®K / ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ',
      price_old_21k_gram:      '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡ß®‡ßßK / ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ',
      // new
      price_new_22k_bhori:     '‡¶®‡¶§‡ßÅ‡¶® ‡ß®‡ß®K / ‡¶≠‡¶∞‡¶ø',
      price_new_21k_bhori:     '‡¶®‡¶§‡ßÅ‡¶® ‡ß®‡ßßK / ‡¶≠‡¶∞‡¶ø',
      price_new_22k_gram:      '‡¶®‡¶§‡ßÅ‡¶® ‡ß®‡ß®K / ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ',
      price_new_21k_gram:      '‡¶®‡¶§‡ßÅ‡¶® ‡ß®‡ßßK / ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ',
    };

    const GROUPS = {
      today: ['price_24k_biscuit_bhori','price_24k_pasha_bhori','price_24k_biscuit_gram'],
      old:   ['price_old_22k_bhori','price_old_21k_bhori','price_old_22k_gram','price_old_21k_gram'],
      new:   ['price_new_22k_bhori','price_new_21k_bhori','price_new_22k_gram','price_new_21k_gram']
    };

    // key -> {curEl,input}
    const rowMap = new Map();

    function addRow(tbody, key){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-3 py-2">${LABELS[key] || key}</td>
        <td class="px-3 py-2 font-semibold" data-cur>‚Äî</td>
        <td class="px-3 py-2">
          <input class="w-32 px-2 py-1 rounded bg-white/10 outline-none" type="number" inputmode="numeric" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶¶‡¶æ‡¶Æ">
        </td>
      `;
      tbody.appendChild(tr);
      const curEl = tr.querySelector('[data-cur]');
      const input = tr.querySelector('input');
      rowMap.set(key,{curEl,input});
    }

    // ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶æ‡¶ï‡¶ö‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø
    function buildTables(){
      GROUPS.today.forEach(key => addRow(tbodyToday, key));
      GROUPS.old.forEach(key   => addRow(tbodyOld, key));
      GROUPS.new.forEach(key   => addRow(tbodyNew, key));
    }
    buildTables();

    function fmtDhaka(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
        return d ? d.toLocaleString('bn-BD',{ timeZone:'Asia/Dhaka', dateStyle:'short', timeStyle:'medium' }) : '‚Äî';
      }catch{ return '‚Äî'; }
    }

    // ==== Auth state ====
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        // role/email ‡¶ö‡ßá‡¶ï
        const token = await getIdTokenResult(user, true);
        const email = user.email || '';
        const isAdmin = (token.claims?.role === 'admin') || (email === ADMIN_EMAIL);

        whoEmail.textContent = email;
        whoRole.textContent  = isAdmin ? 'admin' : (token.claims?.role || 'user');

        // ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        loginBox.classList.add('hidden');
        panel.classList.remove('hidden');

        // Live prices
        onSnapshot(collection(db,'prices'), (snap)=>{
          snap.docs.forEach(d=>{
            const data = d.data() || {};
            const key  = data.key || d.id;
            const price = typeof data.price === 'number' ? data.price : null;
            const row = rowMap.get(key);
            if(row && price!=null){
              row.curEl.textContent = moneyFmt.format(price).replace('‡ß≥\u00A0','‡ß≥');
            }
          });
        });

        // Last updated time
        onSnapshot(doc(db,'meta','site'), (snap)=>{
          updatedAtEl.textContent = fmtDhaka(snap.data()?.updatedAt);
        });

      } else {
        panel.classList.add('hidden');
        loginBox.classList.remove('hidden');
      }
    });

    // ==== Login click ====
    btnLogin.addEventListener('click', async ()=>{
      loginMsg.textContent = '';
      const email = emailInput.value.trim();
      const pass  = passInput.value.trim();
      if(!email || !pass){ loginMsg.textContent='‡¶á‡¶Æ‡ßá‡¶á‡¶≤/‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®'; return; }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(err){
        loginMsg.textContent = err?.message || String(err);
      }
    });

    // ==== Save All ====
    btnSave.addEventListener('click', async ()=>{
      try{
        const user = auth.currentUser;
        if(!user){ saveMsg.textContent='‡¶Ü‡¶ó‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®'; saveMsg.className='text-red-400'; return; }

        const token = await getIdTokenResult(user, true);
        const email = user.email || '';
        const isAdmin = (token.claims?.role === 'admin') || (email === ADMIN_EMAIL);
        if(!isAdmin){ saveMsg.textContent='‡¶Ü‡¶™‡¶®‡¶ø admin ‡¶®‡¶®'; saveMsg.className='text-amber-400'; return; }

        for(const [key,obj] of rowMap){
          const raw = (obj.input.value||'').trim();
          if(!raw) continue;
          const num = Number(raw);
          if(!Number.isFinite(num)) throw new Error(`Invalid number for ${key}`);
          await setDoc(doc(db,'prices', key), { key, price:num }, { merge:true });
          obj.input.value = '';
        }
        await setDoc(doc(db,'meta','site'), { updatedAt: serverTimestamp() }, { merge:true });

        saveMsg.textContent = '‚úÖ Saved!';
        saveMsg.className   = 'text-green-400';
      }catch(err){
        saveMsg.textContent = '‚ùå ' + (err?.message || err);
        saveMsg.className   = 'text-red-400';
        console.error(err);
      }
    });
  </script>
</body>
</html>
